<template id="template-scenario-builder">
  <div class="scenario-builder">

    <!-- the grey toolbar for scenario builder -->
    <nav class="navbar navbar-default navbar-static-top tool-bar" id="tool-bar">
      <div class="container-fluid">
        <div class="row" >
          <div class="col-xs-12">
            <div class="btn-toolbar">
              <!-- mixed button and a tags will be fixed soon! -->
              <button class=" btn btn-primary" id="scenario-submit" v-on:click="submitScenario" value="" v-bind:class="{ 'inputdisabled': !(totalRuns <= 20 && validForm) }" >
                Submit
              </button>

              <a href="#/" class="btn btn-primary pull-left">Cancel</a>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- User has to select a template first -->

    <div class="container-fluid" id="below-tool-bar">
      <div class="row">
        <div class="col-sm-12">
          <h2>Scenario builder</h2>
        </div>
      </div>

      <div class="row">
        <!-- 2 column layout, 1st column scenario properties -->
        <div class="col-sm-5">
          <!--  -->
          <div class="row" v-if="availableTemplates.length">
            <div class="col-sm-12">
              <div class="form-group ">
                <label for="select-template">Select a template</label>
                <select class="combobox form-control" v-model="template"  id="select-template" :onchange="selectTemplate(template)">
                  <option v-for="template in availableTemplates" v-bind:value="template">
                    {{ template.name }}
                  </option>
                </select>
              </div>
            </div>
          </div>

          <!-- if user selected something, show GUI -->
          <div>
            <div>
              <!-- the vue validator config, stores form validation result in validation -->
              <validator name="validation">
                <form novalidate>
                  <div v-for="section in scenarioConfig.sections">
                    <div class="panel panel-default">
                      <div class="panel-heading">
                        <h3 class="panel-title">{{section.name}}</h3>
                      </div>
                      <div class="panel-body">
                        <div class="form-group" v-for="variable in section.variables" v-bind:class="{'has-error': $validation[getId(variable)] && !$validation[getId(variable)].valid}">
                          <label class="control-label" for="{{variable.id}}">
                            {{ variable.name }}
                            <!-- TODO: get rid of this space -->
                            <span v-if="variable.description" class="glyphicon glyphicon-info-sign" data-toggle="tooltip" data-placement="right" title="{{variable.description}}"></span>

                            <span v-if="variable.validators.min !== undefined">
                              [{{ variable.validators.min }} - {{ variable.validators.max }}]
                            </span>

                            <span v-if="variable.type === 'select'">
                              <!-- set notation of classes -->
                              {<span v-for="(i, option) in variable.options">{{ option.text}}<span v-if="i < variable.options.length - 1">, </span></span>}
                            </span>
                          </label>
                          <div class="input-group">
                            <!-- numeric, text, semver or factor are inputs-->
                            <template v-if="['numeric', 'text', 'semver'].includes(variable.type) || variable.factor">
                              <input
                                     type="{{ variable.type }}"
                                     class="form-control"
                                     id="{{ variable.id }}"
                                     :data-role="variable.factor ? 'tagsinput' : ''"
                                     v-model="variable.value"
                                     :disabled="variable.disabled"
                                     :field="getId(variable)"
                                     v-validate="variable.validators"
                                     />
                            </template>
                            <!-- select if not form -->
                            <template v-if="variable.type === 'select' && !variable.factor">
                              <select
                                     class="form-control"
                                     id="{{ variable.id }}"
                                     v-model="variable.value"
                                     :field="getId(variable)"
                                     v-validate="variable.validators"
                                     >
                                <option
                                   v-for="option in variable.options"
                                   v-bind:value="option">
                                  {{ option.text }}
                                </option>
                              </select>
                            </template>
                            <!-- text area -->
                            <template
                               v-if="variable.type === 'textarea'"
                               >
                              <textarea
                                 class="form-control"
                                 rows="3"
                                 :disabled="variable.disabled"
                                 :field="getId(variable)"
                                 v-validate="variable.validators"
                                 >{{ variable.value }}</textarea>
                            </template>
                            <!-- if we add this to 1 we need to add it to all, bug in bootstrap -->
                            <span class="input-group-addon" >
                              {{ variable.units || '-' }}
                            </span>

                          </div>
                          <!-- TODO: replace this part by messages -->
                          <div v-if="$validation[getId(variable)]">
                            <p  v-if="$validation[getId(variable)].required"
                                class="help-block has-error">
                              This field cannot be left empty.
                            </p>
                            <template  v-if="$validation[getId(variable)].min
                                             && !$validation[getId(variable)].required
                                             && variable.type === 'numeric'">
                              <template
                                 v-for="input in variable.value.split(',')">
                                <p v-if="!isNaN(input) && input < variable.validators.min"
                                   class="help-block has-error">
                                  Entered value "{{ input }}" is less than the minimum value "{{ variable.validators.min }}".
                                </p>
                              </template>
                            </template>
                            <template  v-if="$validation[getId(variable)].max
                                             && !$validation[getId(variable)].required
                                             && variable.type === 'numeric'">
                              <template
                                 v-for="input in variable.value.split(',')">
                                <p v-if="!isNaN(input) && input > variable.validators.max"
                                   class="help-block has-error">
                                  Entered value "{{ input }}" is greater than the maximum value "{{ variable.validators.max }}".
                                </p>
                              </template>
                            </template>
                            <template  v-if="$validation[getId(variable)]
                                             && !$validation[getId(variable)].valid
                                             && variable.type === 'numeric'">
                              <template
                                 v-for="input in variable.value.split(',')">
                                <p v-if="isNaN(input)"
                                   class="help-block has-error">
                                  "{{ input }}" is not a number.
                                </p>
                              </template>
                            </template>
                          </div>
                        </div>

                      </div>
                    </div>


                  </div>
                </form>
                <!-- <pre> -->
                <!--   {{ $validation | json }} -->
                <!-- </pre> -->

              </validator>
            </div>


            <!-- expected runs indicator. It becomes a different color if the totalRuns exceed 20 -->
            <div class="row" >
              <div class="col-sm-12">
                <div class="alert alert-info" v-bind:class="{ 'alert-warning': totalRuns > 20}" role="alert">
                  <p class="lead">Expected runs: <strong>{{totalRuns}}</strong></p>
                  <p v-if="totalRuns > 20">
                    At the moment you cannot submit more than 20 runs in one scenario.
                  </p>

                </div>
              </div>
            </div>

          </div>



        </div>


        <div class="col-sm-7">
          <div v-if="template">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h3 class="panel-title">Details for {{ template.name }} <small>id: {{ template.id }}</small></h3>
              </div>
              <!-- template details -->
              <div class="panel-body">
                <dl class="dl-horizontal">
                  <template v-for="(key, val) in template.meta">
                    <dt>{{ key }}</dt>
                    <dd>{{ val }}</dd>
                  </template>
                </dl>
              </div>
            </div>
            <div class="panel panel-default">
              <div class="panel-heading">
                <h3 class="panel-title">Schematic</h3>
              </div>
              <!-- template details -->
              <div class="panel-body  text-center">
                <img src="images/schematic.svg" class="scenariobuilder-schematic" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
